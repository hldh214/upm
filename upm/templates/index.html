<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPM Price History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .header { margin-bottom: 2rem; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="header text-center">
            <h1>Product Price History</h1>
            <p class="text-muted">Enter a Product ID to view historical price trends</p>
        </div>

        <div class="row justify-content-center mb-5">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="productId" class="form-control form-control-lg" placeholder="Enter Product ID">
                    <button class="btn btn-primary btn-lg" type="button" onclick="searchProduct()">Search</button>
                </div>
            </div>
        </div>

        <div id="resultArea" style="display:none;">
            <div class="card mb-4">
                <div class="card-body">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">History Data</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0" id="dataTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Price Group</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorArea" class="alert alert-danger mt-3 text-center" style="display:none;"></div>
    </div>

    <script>
        let myChart = null;

        async function searchProduct() {
            const pid = document.getElementById('productId').value.trim();
            if (!pid) return;

            const resultArea = document.getElementById('resultArea');
            const errorArea = document.getElementById('errorArea');
            const tbody = document.querySelector('#dataTable tbody');

            resultArea.style.display = 'none';
            errorArea.style.display = 'none';
            tbody.innerHTML = '';

            try {
                const response = await fetch(`/api/history/${pid}`);
                const data = await response.json();

                if (Object.keys(data).length === 0) {
                    errorArea.textContent = 'No history found for this Product ID.';
                    errorArea.style.display = 'block';
                    return;
                }

                resultArea.style.display = 'block';
                renderChart(data);
                renderTable(data);

            } catch (err) {
                console.error(err);
                errorArea.textContent = 'Error fetching data.';
                errorArea.style.display = 'block';
            }
        }

        function renderChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');

            if (myChart) {
                myChart.destroy();
            }

            const datasets = [];
            const colors = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8'];
            let colorIdx = 0;

            // Collect all unique labels (dates) and sort them
            let allDates = new Set();
            for (const group in data) {
                data[group].forEach(item => allDates.add(item.date));
            }
            const labels = Array.from(allDates).sort();

            for (const group in data) {
                // Prepare data points.
                // Since x-axis is categorical (labels), we need to match data to labels or use x/y objects.
                // Using x/y objects with Chart.js is flexible.

                const groupData = data[group].map(d => ({x: d.date, y: d.price}));

                datasets.push({
                    label: `Group ${group}`,
                    data: groupData,
                    borderColor: colors[colorIdx % colors.length],
                    backgroundColor: colors[colorIdx % colors.length],
                    tension: 0.1,
                    fill: false
                });
                colorIdx++;
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'category',
                            title: { display: true, text: 'Date' }
                        },
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Price' }
                        }
                    }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.querySelector('#dataTable tbody');
            const rows = [];

            for (const group in data) {
                data[group].forEach(item => {
                    rows.push({
                        date: item.date,
                        group: group,
                        price: item.price
                    });
                });
            }

            // Sort by date desc
            rows.sort((a, b) => b.date.localeCompare(a.date));

            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.group}</td>
                    <td>${row.price}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Allow Enter key to search
        document.getElementById('productId').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                searchProduct();
            }
        });
    </script>
</body>
</html>
